<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Usage :: Stackable Documentation</title>
    <link rel="canonical" href="https://docs.stackable.tech/airflow/usage.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../_/css/site.css">
    <script>var uiRootPath = '../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.stackable.tech">Stackable Documentation</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="airflow" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Stackable Operator for Apache Airflow</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="installation.html">Installation</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="usage.html">Usage</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Stackable Operator for Apache Airflow</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../home/index.html">Stackable Documentation</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../home/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="index.html">Stackable Operator for Apache Airflow</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../druid/index.html">Stackable Operator for Apache Druid</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../druid/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../hbase/index.html">Stackable Operator for Apache HBase</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../hbase/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../hdfs/index.html">Stackable Operator for Apache HDFS</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../hdfs/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../hive/index.html">Stackable Operator for Apache Hive</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../hive/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../kafka/index.html">Stackable Operator for Apache Kafka</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../kafka/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../nifi/index.html">Stackable Operator for Apache NiFi</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../nifi/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../spark/index.html">Stackable Operator for Apache Spark</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../spark/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../superset/index.html">Stackable Operator for Apache Superset</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../superset/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../zookeeper/index.html">Stackable Operator for Apache ZooKeeper</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../zookeeper/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../monitoring/index.html">Stackable Operator for Monitoring and Metrics</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../monitoring/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../opa/index.html">Stackable Operator for OpenPolicyAgent</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../opa/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../regorule/index.html">Stackable Operator for OpenPolicyAgent Rego rules</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../regorule/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../trino/index.html">Stackable Operator for Trino</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../trino/index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../home/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Stackable Operator for Apache Airflow</a></li>
    <li><a href="usage.html">Usage</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/stackabletech/airflow-operator/edit/main/docs/modules/ROOT/pages/usage.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Usage</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Airflow can run in standalone mode (see <a href="https://airflow.apache.org/docs/apache-airflow/stable/start/local.html" class="bare">https://airflow.apache.org/docs/apache-airflow/stable/start/local.html</a>) but requires 2 external dependencies if we want to run jobs across more than one worker: these
dependencies are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>an external database (e.g. postgresql) for user/job data, and</p>
</li>
<li>
<p>a queuing component such as Redis.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_external_dependencies_for_the_airflow_usersjob_data_and_job_queues"><a class="anchor" href="#_external_dependencies_for_the_airflow_usersjob_data_and_job_queues"></a>External dependencies for the Airflow users/job data and job queues</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For testing purposes, first add the bitnami repository to helm:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm repo add bitnami https://charts.bitnami.com/bitnami</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can spin up a PostgreSQL database with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm install airflow-postgresql bitnami/postgresql --version 11.0.0 \
    --set auth.username=airflow \
    --set auth.password=airflow \
    --set auth.database=airflow</code></pre>
</div>
</div>
<div class="paragraph">
<p>A Redis instance can be setup in a similar way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm install redis bitnami/redis \
    --set auth.password=redis</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_secret_with_airflow_credentials"><a class="anchor" href="#_secret_with_airflow_credentials"></a>Secret with Airflow credentials</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A secret with the necessary credentials must be created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: simple-airflow-credentials
type: Opaque
stringData:
  adminUser.username: airflow
  adminUser.firstname: Airflow
  adminUser.lastname: Admin
  adminUser.email: airflow@airflow.com
  adminUser.password: airflow
  connections.secretKey: thisISaSECRET_1234
  connections.sqlalchemyDatabaseUri: postgresql+psycopg2://airflow:airflow@airflow-postgresql.default.svc.cluster.local/airflow
  connections.celeryResultBackend: db+postgresql://airflow:airflow@airflow-postgresql.default.svc.cluster.local/airflow
  connections.celeryBrokerUrl: redis://:redis@redis-master:6379/0</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>connections.secretKey</code> will be used for securely signing the session cookies and can be used
for any other security related needs by extensions. It should be a long random string of bytes.</p>
</div>
<div class="paragraph">
<p><code>connections.sqlalchemyDatabaseUri</code> must contain the connection string to the SQL database storing
the Airflow metadata.</p>
</div>
<div class="paragraph">
<p><code>connections.celeryResultBackend</code> must contain the connection string to the SQL database storing
the job metadata (in the example above we are using the same postgresql database for both).</p>
</div>
<div class="paragraph">
<p><code>connections.celeryBrokerUrl</code> must contain the connection string to the Redis instance used for queuing
the jobs submitted to the airflow worker(s).</p>
</div>
<div class="paragraph">
<p>The <code>adminUser</code> fields are used by the <code>init</code> command to create an admin user.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creation_of_an_airflow_cluster"><a class="anchor" href="#_creation_of_an_airflow_cluster"></a>Creation of an Airflow Cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>An Airflow cluster must be created as a custom resource:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: airflow.stackable.tech/v1alpha1
kind: AirflowCluster
metadata:
  name: airflow
spec:
  version: 2.2.3-python3.8
  executor: CeleryExecutor
  loadExamples: true
  exposeConfig: false
  webservers:
    roleGroups:
      default:
        config:
          credentialsSecret: simple-airflow-credentials
  workers:
    roleGroups:
      default:
        config:
          credentialsSecret: simple-airflow-credentials
        replicas: 2
  schedulers:
    roleGroups:
      default:
        config:
          credentialsSecret: simple-airflow-credentials</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>metadata.name</code> contains the name of the Airflow cluster</p>
</li>
<li>
<p>the label of the Docker image provided by Stackable must be set in <code>spec.version</code></p>
</li>
<li>
<p><code>spec.executor</code>: this setting determines how the cluster will run (for more information see <a href="https://airflow.apache.org/docs/apache-airflow/stable/executor/index.html#executor-types" class="bare">https://airflow.apache.org/docs/apache-airflow/stable/executor/index.html#executor-types</a>): the <code>CeleryExecutor</code>
is the recommended setting although <code>SequentialExecutor</code> (all jobs run in one process in series) and <code>LocalExecutor</code>
(whereby all jobs are run on one node, using whatever parallelism is possible) are also supported</p>
</li>
<li>
<p>importing the sample workflows is determined by <code>loadExamples</code></p>
</li>
<li>
<p><code>exposeConfig</code> allows the contents of the configuration file <code>airflow.cfg</code> to be exposed via the webserver UI. This is only for debugging purposes and should be set to <code>false</code> otherwise as it presents a security risk.</p>
</li>
<li>
<p>the previously created secret must be referenced in <code>credentialsSecret</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each cluster requires 3 components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>webservers</code>: this provides the main UI for user-interaction</p>
</li>
<li>
<p><code>workers</code>: the nodes over which the job workload will be distributed by the scheduler</p>
</li>
<li>
<p><code>schedulers</code>: responsible for triggering jobs and persisting their metadata to the backend database</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_environment_overrides"><a class="anchor" href="#_configuration_environment_overrides"></a>Configuration &amp; Environment Overrides</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The cluster definition also supports overriding configuration properties and environment variables, either per role or per role group, where the more specific override (role group) has precedence over the less specific one (role).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Overriding certain properties which are set by operator (such as the HTTP port) can interfere with the operator and can lead to problems. Additionally for Airflow it is recommended
that each component has the same configuration: not all components use each setting, but some things - such as external end-points - need to be consistent for things to work as expected.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_configuration_properties"><a class="anchor" href="#_configuration_properties"></a>Configuration Properties</h3>
<div class="paragraph">
<p>Airflow exposes an environment variable for every configuration setting, a list of which can be found in the <a href="https://airflow.apache.org/docs/apache-airflow/stable/configurations-ref.html">Configuration Reference</a>.</p>
</div>
<div class="paragraph">
<p>Although Kubernetes can override these settings in one of two ways (Configuration overrides, or Environment Variable overrides), the affect is the same
and currently only the latter is implemented. This is described in the following section.</p>
</div>
</div>
<div class="sect2">
<h3 id="_environment_variables"><a class="anchor" href="#_environment_variables"></a>Environment Variables</h3>
<div class="paragraph">
<p>These can be set - or overwritten - at either the role level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  webservers:
    envOverrides:
      AIRFLOW__WEBSERVER__AUTO_REFRESH_INTERVAL: "8"
    roleGroups:
      default:
        config:
          credentialsSecret: simple-airflow-credentials</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or per role group:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">  webservers:
    roleGroups:
      default:
        envOverrides:
          AIRFLOW__WEBSERVER__AUTO_REFRESH_INTERVAL: "8"
        config:
          credentialsSecret: simple-airflow-credentials</code></pre>
</div>
</div>
<div class="paragraph">
<p>In both examples above we are replacing the default value of the UI DAG refresh (3s) with 8s. Note that all override property values must be strings.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_initializing_the_airflow_database"><a class="anchor" href="#_initializing_the_airflow_database"></a>Initializing the Airflow database</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If the database is not initialized yet for Airflow, the <code>init</code> command must be executed: the
command initializes the database by creating the necessary database tables, creating the admin user
account, and loading examples if desired. The webserver will not be available/ready until this initialization
step has been completed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: command.airflow.stackable.tech/v1alpha1
kind: Init
metadata:
  name: airflow-cluster-command-init
spec:
  clusterRef:
    name: airflow
  credentialsSecret: simple-airflow-credentials</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>spec.clusterRef.name</code> refers to the name of the Airflow cluster.</p>
</div>
<div class="paragraph">
<p>The previously created secret must be referenced in <code>spec.credentialsSecret</code>.</p>
</div>
<div class="paragraph">
<p>A Kubernetes job is created which starts a pod to initialize the database. This can take a while.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_airflow"><a class="anchor" href="#_using_airflow"></a>Using Airflow</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When the Airflow cluster is created and the database is initialized, Airflow can be opened in the
browser.</p>
</div>
<div class="paragraph">
<p>The Airflow port which defaults to <code>8080</code> can be forwarded to the local host:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl port-forward airflow-webserver-default-0 8080</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then it can be opened in the browser with <code><a href="http://localhost:8080" class="bare">http://localhost:8080</a></code>.</p>
</div>
<div class="paragraph">
<p>Enter the admin credentials from the Kubernetes secret:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/airflow_login.png" alt="Login screen of Airflow">
</div>
</div>
<div class="paragraph">
<p>If the examples were loaded then some dashboards are already available:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/airflow_dags.png" alt="Airflow UI showing example DAGs">
</div>
</div>
<div class="paragraph">
<p>Click on an example DAG and then invoke the job: if the scheduler is correctly set up then the job
will run and the job tree will update automatically:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/airflow_running.png" alt="Airflow UI showing a running DAG">
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
</footer>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
