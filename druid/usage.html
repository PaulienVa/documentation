<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Usage :: Stackable Documentation</title>
    <link rel="canonical" href="https://docs.stackable.tech/druid/usage.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../_/css/site.css">
    <script>var uiRootPath = '../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.stackable.tech">Stackable Documentation</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="druid" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Stackable Operator for Apache Druid</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="building.html">Building the Operator</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="installation.html">Installation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="configuration.html">Configuration</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="usage.html">Usage</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Stackable Operator for Apache Druid</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../home/index.html">Stackable Documentation</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../home/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../airflow/index.html">Stackable Operator for Apache Airflow</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../airflow/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="index.html">Stackable Operator for Apache Druid</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../hbase/index.html">Stackable Operator for Apache HBase</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../hbase/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../hdfs/index.html">Stackable Operator for Apache HDFS</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../hdfs/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../hive/index.html">Stackable Operator for Apache Hive</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../hive/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../kafka/index.html">Stackable Operator for Apache Kafka</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../kafka/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../nifi/index.html">Stackable Operator for Apache NiFi</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../nifi/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../spark/index.html">Stackable Operator for Apache Spark</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../spark/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../superset/index.html">Stackable Operator for Apache Superset</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../superset/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../zookeeper/index.html">Stackable Operator for Apache ZooKeeper</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../zookeeper/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../monitoring/index.html">Stackable Operator for Monitoring and Metrics</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../monitoring/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../opa/index.html">Stackable Operator for OpenPolicyAgent</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../opa/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../regorule/index.html">Stackable Operator for OpenPolicyAgent Rego rules</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../regorule/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../trino/index.html">Stackable Operator for Trino</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../trino/index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../home/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Stackable Operator for Apache Druid</a></li>
    <li><a href="usage.html">Usage</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/stackabletech/druid-operator/edit/main/docs/modules/ROOT/pages/usage.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Usage</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Druid requires a Zookeeper to run, as well as a database.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setup_prerequisites"><a class="anchor" href="#_setup_prerequisites"></a>Setup Prerequisites</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_zookeeper_operator"><a class="anchor" href="#_zookeeper_operator"></a>Zookeeper operator</h3>
<div class="paragraph">
<p>Please refer to the <a href="https://github.com/stackabletech/zookeeper-operator">Zookeeper</a> operator and <a href="https://docs.stackable.tech/zookeeper/index.html">docs</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_sql_database"><a class="anchor" href="#_sql_database"></a>SQL Database</h3>
<div class="paragraph">
<p>Druid requires a MySQL or Postgres database.</p>
</div>
<div class="paragraph">
<p>For testing purposes, you can spin up a PostgreSQL database with the bitnami PostgreSQL helm chart.  Add the bitnami repository:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm repo add bitnami https://charts.bitnami.com/bitnami</code></pre>
</div>
</div>
<div class="paragraph">
<p>And set up the Postgres database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm install druid bitnami/postgresql \
--version=11 \
--set auth.username=druid \
--set auth.password=druid \
--set auth.database=druid</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creating_a_druid_cluster"><a class="anchor" href="#_creating_a_druid_cluster"></a>Creating a Druid Cluster</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With the prerequisites fulfilled, the CRD for this operator must be created:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl apply -f /etc/stackable/druid-operator/crd</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then a cluster can be deployed using the example below. Make sure you have <strong>exactly one node</strong> labeled with <code>nodeType=druid-data</code> as used in the deep storage selector. Having more than one data node is not supported when using local storage.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: druid.stackable.tech/v1alpha1
kind: DruidCluster
metadata:
  name: simple-druid
spec:
  version: 0.22.1
  zookeeperConfigMapName: simple-zk
  metadataStorageDatabase:
    dbType: postgresql
    connString: jdbc:postgresql://druid-postgresql/druid
    host: druid-postgresql    # this is the name of the Postgres service
    port: 5432
    user: druid
    password: druid
  deepStorage:
    storageType: local
    dataNodeSelector:
      nodeType: druid-data
    storageDirectory: /path/to/druidDeepStorage
  brokers:
    roleGroups:
      default:
        config: {}
        replicas: 1
  coordinators:
    roleGroups:
      default:
        config: {}
        replicas: 1
  historicals:
    roleGroups:
      default:
        config: {}
        replicas: 1
  middleManagers:
    roleGroups:
      default:
        config: {}
        replicas: 1
  routers:
    roleGroups:
      default:
        config: {}
        replicas: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Router is hosting the web UI, a <code>NodePort</code> service is created by the operator to access the web UI. Connect to the <code>simple-druid-router</code> <code>NodePort</code> service and follow the <a href="https://druid.apache.org/docs/latest/tutorials/index.html#step-4-load-data">druid documentation</a> on how to load and query sample data.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_using_s3"><a class="anchor" href="#_using_s3"></a>Using S3</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Druid can use S3 as a backend for deep storage, as well as a data source to ingest data from.</p>
</div>
<div class="paragraph">
<p>To use S3, add a section like this to you cluster <code>spec</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">s3:
  endpoint: s3-de-central.profitbricks.com
  credentialsSecret: s3-credentials</code></pre>
</div>
</div>
<div class="paragraph">
<p>the secret <code>s3-credentials</code> should contain your access key ID and the secret access key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">apiVersion: v1
kind: Secret
metadata:
  name: s3-credentials
stringData:
  accessKeyId: YOURACCESSKEYIDHERE
  secretAccessKey: YOURSECRETACCESSKEYHERE</code></pre>
</div>
</div>
<div class="paragraph">
<p>This allows to ingest data from accessible buckets already. To configure a bucket and prefix to be used as a deep storage, change the deep storage configuration like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">deepStorage:
  storageType: s3
  bucket: druid-deepstorage
  baseKey: storage           # the base key is the prefix to be used; optional</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_connecting_to_druid_from_other_services"><a class="anchor" href="#_connecting_to_druid_from_other_services"></a>Connecting to Druid from other Services</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The operator creates a <code>ConfigMap</code> with the name of the cluster which contains connection information. Following our example above (the name of the cluster is <code>simple-druid</code>) a <code>ConfigMap</code> with the name <code>simple-druid</code> will be created containing 3 keys:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DRUID_ROUTER</code> with the format <code>&lt;host&gt;:&lt;port&gt;</code>, which points to the router processes HTTP endpoint. Here you can connect to the web UI, or use REST endpoints such as <code>/druid/v2/sql/</code> to query data. <a href="https://druid.apache.org/docs/latest/querying/sql.html#http-post">More information in the Druid Docs</a>.</p>
</li>
<li>
<p><code>DRUID_AVATICA_JDBC</code> contains a JDBC connect string which can be used together with the <a href="https://calcite.apache.org/avatica/downloads/">Avatica JDBC Driver</a> to connect to Druid and query data. <a href="https://druid.apache.org/docs/latest/querying/sql.html#jdbc">More information in the Druid Docs</a>.</p>
</li>
<li>
<p><code>DRUID_SQALCHEMY</code> contains a connection string used to connect to Druid with SQAlchemy, in - for example - Apache Superset.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_environment_overrides"><a class="anchor" href="#_configuration_environment_overrides"></a>Configuration &amp; Environment Overrides</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The cluster definition also supports overriding configuration properties and environment variables, either per role or per role group, where the more specific override (role group) has precedence over the less specific one (role).</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Overriding certain properties which are set by operator (such as the HTTP port) can interfere with the operator and can lead to problems.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_configuration_properties"><a class="anchor" href="#_configuration_properties"></a>Configuration Properties</h3>
<div class="paragraph">
<p>For a role or role group, at the same level of <code>config</code>, you can specify: <code>configOverrides</code> for the <code>runtime.properties</code>. For example, if you want to set the <code>druid.server.http.numThreads</code> for the router to 100 adapt the <code>routers</code> section of the cluster resource like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">routers:
  roleGroups:
    default:
      config: {}
      configOverrides:
        runtime.properties:
          druid.server.http.numThreads: "100"
      replicas: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just as for the <code>config</code>, it is possible to specify this at role level as well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">routers:
  configOverrides:
    runtime.properties:
      druid.server.http.numThreads: "100"
  roleGroups:
    default:
      config: {}
      replicas: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>All override property values must be strings.</p>
</div>
<div class="paragraph">
<p>For a full list of configuration options we refer to the Druid <a href="https://druid.apache.org/docs/latest/configuration/index.html">Configuration Reference</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_environment_variables"><a class="anchor" href="#_environment_variables"></a>Environment Variables</h3>
<div class="paragraph">
<p>In a similar fashion, environment variables can be (over)written. For example per role group:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">routers:
  roleGroups:
    default:
      config: {}
      envOverrides:
        MY_ENV_VAR: "MY_VALUE"
      replicas: 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>or per role:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">routers:
  envOverrides:
    MY_ENV_VAR: "MY_VALUE"
  roleGroups:
    default:
      config: {}
      replicas: 1</code></pre>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
</footer>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
