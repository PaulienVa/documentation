<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Overview :: Stackable Documentation</title>
    <link rel="canonical" href="https://docs.stackable.tech/home/contributor/guides/docathon-22-01/druid.html">
    <meta name="generator" content="Antora 3.0.1">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <script>var uiRootPath = '../../../../_'</script>
    <link rel="icon" href="../../../../_/img/favicon.png" type="image/png">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="container">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://stackable.de"><img src="../../../../_/img/stackable-logo.png"></a>
      <a class="navbar-item documentation-link" href="https://docs.stackable.tech">Documentation</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
      <a href="https://www.stackable.de/en/contact/" class="button pull-right">Contact Us</a>
    </div>
      <div id="topbar-nav" class="navbar-menu">
      </div>
      </div>
    </nav>
    <nav class="navbar-sub">
      <div class="container">
        <a class="navbar-sub-item" href="../../../index.html">Overview</a>
<a class="navbar-sub-item" href="../../../index.html">Architecture</a>
<a class="navbar-sub-item" href="../../../getting_started.html">Getting Started</a>
<div class="navbar-sub-item drop-down">
    Operators
    <div class="drop-down-content">
    <a class="drop-down-item" href="../../../../airflow/index.html">Apache Airflow</a>
    <a class="drop-down-item" href="../../../../druid/index.html">Apache Druid</a>
    <a class="drop-down-item" href="../../../../hbase/index.html">Apache HBase</a>
    <a class="drop-down-item" href="../../../../hdfs/index.html">Apache Hadoop HDFS</a>
    <a class="drop-down-item" href="../../../../hive/index.html">Apache Hive</a>
    <a class="drop-down-item" href="../../../../kafka/index.html">Apache Kafka</a>
    <a class="drop-down-item" href="../../../../nifi/index.html">Apache NiFi</a>
    <a class="drop-down-item" href="../../../../spark/index.html">Apache Spark (standalone)</a>
    <a class="drop-down-item" href="../../../../spark-k8s/index.html">Apache Spark on K8S</a>
    <a class="drop-down-item" href="../../../../superset/index.html">Apache Superset</a>
    <a class="drop-down-item" href="../../../../trino/index.html">Trino</a>
    <a class="drop-down-item" href="../../../../zookeeper/index.html">Apache ZooKeeper</a>
    <a class="drop-down-item" href="../../../../opa/index.html">OpenPolicyAgent</a>
    <a class="drop-down-item" href="../../../../commons-operator/index.html">Commons</a>
    <a class="drop-down-item" href="../../../../secret-operator/index.html">Secret</a>
    </div>
</div>

        <a class="arrow" href="javascript:document.querySelector('.navbar-sub').classList.toggle('open')">
          <svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="arrow-right" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M190.5 66.9l22.2-22.2c9.4-9.4 24.6-9.4 33.9 0L441 239c9.4 9.4 9.4 24.6 0 33.9L246.6 467.3c-9.4 9.4-24.6 9.4-33.9 0l-22.2-22.2c-9.5-9.5-9.3-25 .4-34.3L311.4 296H24c-13.3 0-24-10.7-24-24v-32c0-13.3 10.7-24 24-24h287.4L190.9 101.2c-9.8-9.3-10-24.8-.4-34.3z"></path></svg>
        </a>
      </div>
    </nav>
  </header>
<div class="body">
    <div class="container">
<div class="nav-container" data-component="home" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../../index.html">Stackable Documentation</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../getting_started.html">Getting Started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../supported-versions.html">Supported Product Versions</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../monitoring.html">Monitoring</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Contributor&#8217;s Guide</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../contribution_guide.html">Overview</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../steps.html">Steps to contribute</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../development_dashboard.html">Development Dashboard</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../service_discovery.html">Service Discovery</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../opa_configuration.html">OPA Configuration</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Architectural Decision Records</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Current</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../adr/ADR001-choose_project_language.html">ADR001: Use English as Documentation Language</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../adr/ADR002-choose_repository_structure.html">ADR002: Use Multiple Repositories instead of one Large Repository</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../adr/ADR003-choose_review_mechanism.html">ADR003: Use RTC as Review Mechanism for Changes</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../adr/ADR004-choose_agent_programming_language.html">ADR004: Use Rust as programming language for the agent</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../adr/ADR005-systemd_unit_file_location.html">ADR005: Decide on handling and location of systemd unit files</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../adr/ADR007-defined_reuse_of_k8s.html">ADR007: Decide if Kubernetes Components Are to be Reused for Stackable</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../adr/ADR008-decide_reuse_of_operators.html">ADR008: Allow Reuse of Existing Kubernetes Operators</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../adr/ADR009-selector_support.html">ADR009: Assigning Services to Nodes</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../adr/ADR010-command_pattern.html">ADR010: Expressing one-shot commands in a Kubernetes-native way</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../adr/ADR011-directory_structure.html">ADR011: Directory Structure Used by Stackable Components on Managed Hosts</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../adr/ADR012-authn_token_management.html">ADR012: Authentication token management</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../adr/ADR013-user_authentication_for_products.html">ADR013: User Authentication for Products</a>
  </li>
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../adr/ARD014-using_values_from_configmaps.html">ADR014: How Should Operators Use Values from ConfigMaps &amp; Secrets</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Deprecated</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../adr/deprecated/ADR006-choose_orchestrator_storage_backend.html">Use xxx as storage backend for the orchestrator</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="3">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Drafts</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="4">
    <a class="nav-link" href="../../adr/drafts/ADRx-choose_authorization_engine.html">Choose Authorization Engine</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Stackable Documentation</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../../commons-operator/index.html">Stackable Commons Operator</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../commons-operator/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../../../index.html">Stackable Documentation</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../../../index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../airflow/index.html">Stackable Operator for Apache Airflow</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../airflow/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../druid/index.html">Stackable Operator for Apache Druid</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../druid/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../hbase/index.html">Stackable Operator for Apache HBase</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../hbase/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../hdfs/index.html">Stackable Operator for Apache HDFS</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../hdfs/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../hive/index.html">Stackable Operator for Apache Hive</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../hive/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../kafka/index.html">Stackable Operator for Apache Kafka</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../kafka/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../nifi/index.html">Stackable Operator for Apache NiFi</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../nifi/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../spark/index.html">Stackable Operator for Apache Spark</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../spark/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../spark-k8s/index.html">Stackable Operator for Apache Spark on Kubernetes</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../spark-k8s/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../superset/index.html">Stackable Operator for Apache Superset</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../superset/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../zookeeper/index.html">Stackable Operator for Apache ZooKeeper</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../zookeeper/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../opa/index.html">Stackable Operator for OPA</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../opa/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../trino/index.html">Stackable Operator for Trino</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../trino/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../../secret-operator/index.html">Stackable Secret Operator</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../../secret-operator/index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../../index.html">Stackable Documentation</a></li>
    <li><a href="druid.html">Overview</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/stackabletech/documentation/edit/main/modules/contributor/pages/guides/docathon-22-01/druid.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Overview</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This section describes how to set up a streaming job in Druid to ingest data from the Kafka topic that was used with Nifi. Druid requires a backing storage (so called Deep-Storage) where data - partioned by date or time - is persisted as immutable "segments". Druid can use either local storage (only appropriate for stand-alone testing - i.e. all druid components run on the same machine), S3 or HDFS. In this guide we will use S3, specifically MinIO which is an S3-implementation suitable for low-footprint scenarios.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_minio"><a class="anchor" href="#_deploy_minio"></a>Deploy MinIO</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm install minio --set resources.requests.memory=8Gi --set mode=standalone --set replicas=1  --set persistence.enabled=false  --set "buckets[0].name=nytaxidata,buckets[0].policy=none" --set "users[0].accessKey=minioAccessKey,users[0].secretKey=minioSecretKey,users[0].policy=readwrite" --repo https://charts.min.io/ minio</code></pre>
</div>
</div>
<div class="paragraph">
<p>N.B.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>we are specifying a memory allocation of 8GB as Min-IO will use 16GB by default.</p>
</li>
<li>
<p>the access credentials are given above in the form of a secret, which will be used later in the Druid custom resource.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_postgresql_for_druid_metadata"><a class="anchor" href="#_deploy_postgresql_for_druid_metadata"></a>Deploy Postgresql (for Druid metadata)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Druid requires a database to store metadata: for this guide we will use the Bitnami PostgreSQL helm chart to deploy a PostgreSQL instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm install postgresql-druid \
    --repo https://charts.bitnami.com/bitnami postgresql \
    --set auth.username=druid \
    --set auth.password=druid \
    --set auth.database=druid \
    --version 11.0.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>N.B. the credentials will also be used in the Druid custom resource.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_the_stackable_druid_operator"><a class="anchor" href="#_deploy_the_stackable_druid_operator"></a>Deploy the Stackable Druid operator</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">helm install druid-operator stackable-stable/druid-operator</code></pre>
</div>
</div>
<div class="paragraph">
<p>N.B. make sure this is not executed in a location that contains a folder called "druid-operator" as the helm installation will not complete successfully!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_the_druid_secret"><a class="anchor" href="#_deploy_the_druid_secret"></a>Deploy the Druid secret</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: v1
kind: Secret
metadata:
  name: druid-s3-credentials <i class="conum" data-value="1"></i><b>(1)</b>
stringData:
  accessKeyId: minioAccessKey
  secretAccessKey: minioSecretKey
EOF</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_the_druid_znode"><a class="anchor" href="#_deploy_the_druid_znode"></a>Deploy the Druid ZNode</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This is required to link our Druid installation to the Zookeeper that we installed earlier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: zookeeper.stackable.tech/v1alpha1
kind: ZookeeperZnode
metadata:
  name: simple-druid-znode <i class="conum" data-value="2"></i><b>(2)</b>
spec:
  clusterRef:
    name: simple-zk
EOF</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_deploy_the_druid_cluster"><a class="anchor" href="#_deploy_the_druid_cluster"></a>Deploy the Druid cluster</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: druid.stackable.tech/v1alpha1
kind: DruidCluster
metadata:
  name: druid-nytaxidata
spec:
  version: 0.22.1
  zookeeperConfigMapName: simple-druid-znode  <i class="conum" data-value="2"></i><b>(2)</b>
  metadataStorageDatabase:
    dbType: postgresql
    connString: jdbc:postgresql://postgresql-druid/druid
    host: postgresql-druid
    port: 5432
    user: druid
    password: druid
  s3:
    endpoint: http://minio:9000
    credentialsSecret: druid-s3-credentials  <i class="conum" data-value="1"></i><b>(1)</b>
  deepStorage:
    storageType: s3
    bucket: nytaxidata
    baseKey: storage
  brokers:
    configOverrides:
      runtime.properties:
        druid.s3.enablePathStyleAccess: "true"
    roleGroups:
      default:
        selector:
          matchLabels:
            kubernetes.io/os: linux
        config: {}
        replicas: 1
  coordinators:
    configOverrides:
      runtime.properties:
        druid.s3.enablePathStyleAccess: "true"
    roleGroups:
      default:
        selector:
          matchLabels:
            kubernetes.io/os: linux
        config: {}
        replicas: 1
  historicals:
    configOverrides:
      runtime.properties:
        druid.s3.enablePathStyleAccess: "true"
    roleGroups:
      default:
        selector:
          matchLabels:
            kubernetes.io/os: linux
        config: {}
        replicas: 1
  middleManagers:
    configOverrides:
      runtime.properties:
        druid.s3.enablePathStyleAccess: "true"
    roleGroups:
      default:
        selector:
          matchLabels:
            kubernetes.io/os: linux
        config: {}
        replicas: 1
  routers:
    configOverrides:
      runtime.properties:
        druid.s3.enablePathStyleAccess: "true"
    roleGroups:
      default:
        selector:
          matchLabels:
            kubernetes.io/os: linux
        config: {}
        replicas: 1
EOF</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>S3 secret</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Druid ZNode</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_data_ingestion"><a class="anchor" href="#_data_ingestion"></a>Data Ingestion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are different ways to get data into Druid, all of which will use a <code>POST</code> of a Druid-compatible ingestion specification. We will document here two ways of doing this, either directly in the Druid UI, or - this is e.g. useful if the job is to be repeated - by extracting the ingestion specification into a JSON file and issuing a curl from the command line (some of what follows is also covered in more depth in the official Druid documentation, but is mentioned here for the sake of completion).</p>
</div>
<div class="sect2">
<h3 id="_using_the_druid_ui"><a class="anchor" href="#_using_the_druid_ui"></a>Using the Druid UI</h3>
<div class="sect3">
<h4 id="_setup_port_forwarding_for_the_druid_ui"><a class="anchor" href="#_setup_port_forwarding_for_the_druid_ui"></a>Setup port-forwarding for the Druid UI</h4>
<div class="paragraph">
<p>Run this from the command line to open up access to the Druid router (keep this command line tab open):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">kubectl port-forward svc/druid-nytaxidata-router 8888</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_druid_ui"><a class="anchor" href="#_druid_ui"></a>Druid UI</h4>
<div class="paragraph">
<p>The UI should now be reachable at <a href="http://localhost:8888" class="bare">http://localhost:8888</a> and should look like the screenshot below. We will start with the “Load Data” option:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/docathon-2022-01/druid-main.png" alt="Main Screen">
</div>
</div>
<div class="paragraph">
<p>Select "Apache Kafka" and then "Connect Data" at the right of the screen, entering the following in the two available fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Bootstrap servers: <code>simple-kafka:9092</code></p>
</li>
<li>
<p>Topic: <code>nytaxidata</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then select "Start of stream" and then "Apply":</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/docathon-2022-01/druid-connect.png" alt="Connect to Kafka">
</div>
</div>
<div class="paragraph">
<p>At the bottom right of the screen click through</p>
</div>
<div class="ulist">
<ul>
<li>
<p>“Parse Data”, “Parse Time”, “Transform”, “Filter”, “Configure Schema”</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>without changing anything. At the next step - “Partition” - select <code>day</code> for the granularity:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/docathon-2022-01/druid-partition.png" alt="Partition">
</div>
</div>
<div class="paragraph">
<p>Then click on “Tune”. At this point we tell Druid how to manage the Kafka offsets. As this is the initial read action we have to choose “True” so that Kafka starts at the earliest possible offset (subsequent reads will pick up from the last offset that Druid has cached internally):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/docathon-2022-01/druid-tuning.png" alt="Offsets">
</div>
</div>
<div class="paragraph">
<p>Click through “Publish” to show “Edit spec”. At this point we have a complete ingestion job specification in JSON format:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/docathon-2022-01/druid-jobspec.png" alt="Ingestion-spec">
</div>
</div>
<div class="paragraph">
<p>At this point we can just click on the final step on the bottom (“Submit”) and the job will start running - since the job is a streaming job it will wait for fresh Kafka data in the specified topic and ingest it into Druid. However, before we do that, save the JSON specification in a separate file (e.g. <code>/tmp/kafka-ingestion-spec.json</code>) as we will also show how to start this job from the command line per <code>curl</code>.</p>
</div>
<div class="paragraph">
<p>Back at the screen, click on “Submit” - the ingestion job will be started, which will take a few moments. As mentioned already, we are starting a streaming job, so it will continue to run in the background (i.e. the status remains <code>RUNNING</code>):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/docathon-2022-01/druid-task.png" alt="Task">
</div>
</div>
<div class="paragraph">
<p>The magnifying glass icon shows metadata such as logs, spec-definition etc:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/docathon-2022-01/druid-running.png" alt="Running job">
</div>
</div>
<div class="paragraph">
<p>Once the ingestion job has been started, Druid monitors the relevant Kafka topic for changes and ingest new data, persisting it in its deep storage. It can take a few moments for the first segments to be ready (and a bit longer until they are published as immutable segments in deep storage). The streaming job will stay at RUNNING until such time as it is stopped. The datasource is visible under the “Datasources” tab, where the individual segments - partitioned by time slice - can also be examined:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/docathon-2022-01/druid-datasources.png" alt="Datasources">
</div>
</div>
<div class="paragraph">
<p>We can also display data by issuing queries against our datasource from within the SQL designer under the “Query” tab:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../../_images/docathon-2022-01/druid-query.png" alt="Query screen">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_curl"><a class="anchor" href="#_using_curl"></a>Using <code>curl</code></h3>
<div class="paragraph">
<p>We will now perform the same action using the JSON specification we saved earlier (in this guide: <code>/tmp/kafka-ingestion-spec.json</code>).</p>
</div>
<div class="sect3">
<h4 id="_setup_port_forwarding_for_druid_co_ordinator"><a class="anchor" href="#_setup_port_forwarding_for_druid_co_ordinator"></a>Setup port-forwarding for Druid Co-ordinator</h4>
<div class="paragraph">
<p>Issue a port-forwarding command so that we can access the Druid co-ordinator from outside the the Kubernetes cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">kubectl port-forward svc/druid-nytaxidata-coordinator 8081</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_post_job_specification"><a class="anchor" href="#_post_job_specification"></a>Post Job Specification</h4>
<div class="paragraph">
<p>Issue a POST via curl, referencing the JSON specification:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">curl -X POST -H 'Content-Type: application/json' -d @/tmp/kafka-ingestion-spec.json http://localhost:8081/druid/indexer/v1/supervisor</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should yield a status code of 200 with a response of <code>{"id":"nytaxidata"}</code>.</p>
</div>
<div class="paragraph">
<p>N.B. We have extracted our ingestion specification from the UI, where the datasource was created as part of the process, but we could also run this job without an existing datasource, as the job will create it if needed.</p>
</div>
</div>
</div>
</div>
</div>
</article>
  </div>
</main>
    </div>
</div>
<footer class="footer">
</footer>
<script src="../../../../_/js/site.js"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
  </body>
</html>
